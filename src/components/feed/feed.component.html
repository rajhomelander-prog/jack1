<div class="space-y-6">
  <!-- Create Post Card -->
  <div class="bg-elevated-card border border-border-color rounded-xl p-5">
    <div class="flex items-start space-x-4">
      <img class="h-10 w-10 rounded-full" src="https://picsum.photos/seed/currentuser/40/40" alt="User Avatar">
      <div class="flex-1">
        <form [formGroup]="newPostForm" (ngSubmit)="addPost()">
          <div class="relative">
            <textarea formControlName="content" 
                      rows="1" 
                      placeholder="Share your thoughtsâ€¦" 
                      (input)="autosizeTextarea($event)"
                      class="w-full bg-transparent text-text-primary text-base placeholder-text-secondary focus:outline-none resize-none peer"></textarea>
            <div class="absolute bottom-0 left-0 w-full h-px bg-border-color scale-x-0 peer-focus:scale-x-100 transition-transform duration-300 ease-in-out origin-center"
                 style="background-image: linear-gradient(to right, transparent, #E50914, transparent);"></div>
          </div>

          <!-- Image Preview -->
          @if (postImagePreview(); as imageUrl) {
            <div class="mt-4 relative animate-fade-in">
              <img [src]="imageUrl" alt="Image preview" class="w-full rounded-lg border border-border-color">
              <button (click)="removeImage()" type="button" class="absolute top-2 right-2 bg-black/60 text-white rounded-full p-1 hover:bg-black/80 transition-colors">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
              </button>
            </div>
          }

          <!-- Poll Creator -->
          @if (isCreatingPoll()) {
            <div class="mt-4 space-y-2 animate-fade-in" formArrayName="pollOptions">
              @for(option of pollOptions.controls; track $index) {
                <div class="flex items-center space-x-2">
                  <input [formControlName]="$index" type="text" [placeholder]="'Option ' + ($index + 1)" class="flex-grow bg-card-background border border-border-color rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-accent-red">
                  @if (pollOptions.length > 2) {
                    <button (click)="removePollOption($index)" type="button" class="text-text-secondary hover:text-negative-red p-1">
                       <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                  }
                </div>
              }
              @if (pollOptions.length < 4) {
                 <button (click)="addPollOption()" type="button" class="w-full text-left text-sm font-semibold text-accent-red hover:underline p-2">+ Add option</button>
              }
            </div>
          }

          <div class="flex justify-between items-center mt-4 pt-2 border-t border-border-color">
            <div class="flex items-center space-x-1 text-text-secondary">
              <button (click)="attachImage()" type="button" class="p-2 rounded-full hover:bg-card-background transition-colors" [class.text-accent-red]="postImagePreview()" title="Add Image">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 0 1 3.182 0l5.159 5.159m-1.5-1.5 1.409-1.409a2.25 2.25 0 0 1 3.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 0 0 1.5-1.5V6a1.5 1.5 0 0 0-1.5-1.5H3.75A1.5 1.5 0 0 0 2.25 6v12a1.5 1.5 0 0 0 1.5 1.5Z"></path></svg>
              </button>
              <button (click)="togglePollCreation()" type="button" class="p-2 rounded-full hover:bg-card-background transition-colors" [class.text-accent-red]="isCreatingPoll()" title="Create Poll">
                 <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7.5 14.25v-2.5h1.5v2.5h-1.5Zm3-5.25v5.25h1.5V9h-1.5Zm3 2.25v3h1.5v-3h-1.5Z M3.75 3v18h16.5V3H3.75Z"></path></svg>
              </button>
              <button type="button" class="p-2 rounded-full hover:bg-card-background transition-colors" title="Add Location">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1 1 15 0Z"></path></svg>
              </button>
            </div>
            <div class="flex items-center space-x-3">
              <span class="text-xs text-text-secondary" [class.text-negative-red]="remainingChars() < 0" [class.text-warning-yellow]="remainingChars() < 21">{{ remainingChars() }}</span>
              <button type="submit" [disabled]="isPostButtonDisabled()" class="bg-accent-red text-white px-5 py-2 rounded-full text-sm font-bold hover:bg-red-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                Post
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Feed Tabs -->
  <div class="bg-card-background border border-border-color rounded-xl flex items-center p-1">
    @for(type of feedTypes; track type) {
      <button (click)="setFeedType(type)"
              class="flex-1 px-3 py-1.5 text-sm font-semibold rounded-lg transition-colors"
              [class]="activeFeedType() === type ? 'bg-elevated-card text-text-primary' : 'text-text-secondary hover:text-text-primary'">
        {{ type }}
      </button>
    }
  </div>

  <!-- Feed Posts -->
  @for (post of posts(); track post.id) {
    <div class="bg-card-background border border-border-color rounded-xl overflow-hidden animate-fade-in">
      <div class="p-5">
        <!-- Post Header -->
        <div class="flex items-start justify-between mb-4">
          <div class="flex items-center space-x-3">
            <img class="h-10 w-10 rounded-full" [src]="post.author.avatar" alt="{{ post.author.name }} avatar">
            <div>
              <p class="font-semibold text-text-primary text-base">{{ post.author.name }}</p>
              <p class="text-xs text-text-secondary">{{ post.author.role }} &middot; {{ post.time }}</p>
            </div>
          </div>
          <button class="text-text-secondary hover:text-text-primary">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 6a2 2 0 1 1 0-4 2 2 0 0 1 0 4ZM10 12a2 2 0 1 1 0-4 2 2 0 0 1 0 4ZM10 18a2 2 0 1 1 0-4 2 2 0 0 1 0 4Z" /></svg>
          </button>
        </div>

        <!-- Post Content -->
        @let isExpanded = expandedPosts().has(post.id);
        @let isLongPost = post.content.length > 280;
        <p class="text-text-primary text-sm mb-4 whitespace-pre-wrap">
          <span [innerHTML]="(isLongPost && !isExpanded) ? (post.content.substring(0, 280) + '...') : post.content | highlight"></span>
          @if (isLongPost && !isExpanded) {
            <button (click)="togglePostExpansion(post.id)" class="text-accent-red text-sm font-semibold ml-1 hover:underline">Read more</button>
          }
          @if (isLongPost && isExpanded) {
            <button (click)="togglePostExpansion(post.id)" class="text-text-secondary text-sm font-semibold ml-1 hover:underline">Show less</button>
          }
        </p>

        <!-- Post Media -->
        @if (post.image) {
          <div class="mb-4 rounded-lg overflow-hidden border border-border-color">
            <img [src]="post.image" alt="Post image" class="w-full h-auto object-cover">
          </div>
        }

        <!-- Post Poll -->
        @if (post.poll; as poll) {
          <div class="space-y-2 mb-4">
            @if (poll.userVote !== undefined) {
              <!-- Show Results -->
              @for(option of poll.options; track option.id) {
                @let percentage = getPollOptionPercentage(poll, option);
                <div class="relative w-full h-9 rounded-md border border-border-color bg-elevated-card overflow-hidden">
                  <div class="absolute top-0 left-0 h-full bg-accent-red/30 rounded-md transition-all duration-500 ease-out" [style.width.%]="percentage"></div>
                  <div class="absolute inset-0 px-3 flex justify-between items-center text-sm">
                    <div class="flex items-center">
                       <span class="font-semibold text-text-primary">{{ option.text }}</span>
                       @if (poll.userVote === option.id) {
                         <svg class="w-4 h-4 ml-2 text-text-primary" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.704 4.153a.75.75 0 01.143 1.052l-8 10.5a.75.75 0 01-1.127.075l-4.5-4.5a.75.75 0 011.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 011.052-.143z" clip-rule="evenodd" /></svg>
                       }
                    </div>
                    <span class="font-mono text-xs text-text-secondary">{{ percentage | number:'1.0-0' }}%</span>
                  </div>
                </div>
              }
            } @else {
              <!-- Show Voting Options -->
              @for(option of poll.options; track option.id) {
                <button (click)="vote(post.id, option.id)" class="w-full text-left p-2 rounded-md border border-border-color bg-elevated-card hover:border-accent-red transition-colors">
                  <span class="text-sm font-semibold text-text-primary">{{ option.text }}</span>
                </button>
              }
            }
             <p class="text-xs text-text-secondary mt-2">{{ getPollTotalVotes(poll) | number }} votes</p>
          </div>
        }

        <!-- Post Stats -->
        <div class="flex items-center space-x-4 text-xs text-text-secondary mb-2">
            <span><span class="font-bold text-text-primary">{{ post.likes }}</span> Likes</span>
            <span><span class="font-bold text-text-primary">{{ post.comments }}</span> Comments</span>
            <span><span class="font-bold text-text-primary">{{ post.reposts }}</span> Shares</span>
        </div>

      </div>
      <!-- Post Actions -->
      <div class="flex justify-between items-center text-text-secondary border-t border-border-color px-5 py-2">
          <div class="flex items-center space-x-6">
            <button (click)="toggleLike(post)" class="flex items-center space-x-2 hover:text-accent-red transition-colors group" [class.text-accent-red]="post.isLiked">
               <svg class="h-5 w-5" [class.fill-current]="post.isLiked" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.633 10.5c.806 0 1.533-.425 2.031-1.08a9.041 9.041 0 0 1 2.861-2.4c.723-.384 1.35-.956 1.653-1.715a4.498 4.498 0 0 0 .322-1.672V3a.75.75 0 0 1 .75-.75A2.25 2.25 0 0 1 16.5 4.5c0 1.152-.26 2.243-.723 3.218-.266.558.107 1.282.725 1.282h3.126c1.026 0 1.945.694 2.054 1.715.045.422.062.85.062 1.282a1.06 1.06 0 0 1-.062 1.282c-.109 1.022-.99 1.715-2.054 1.715h-3.126c-.618 0-.991.724-.725 1.282.462.975.723 2.066.723 3.218a2.25 2.25 0 0 1-2.25 2.25c-.628 0-1.18-.347-1.477-.854a4.502 4.502 0 0 0-1.99-1.715c-.723-.384-1.35-.956-1.653-1.715a4.498 4.498 0 0 0-.322-1.672v-1.75a.75.75 0 0 0-.75-.75h-2.25a.75.75 0 0 0-.75.75v7.5c0 .414.336.75.75.75h2.25a.75.75 0 0 0 .75-.75v-1.5a.75.75 0 0 1 .75-.75h.75a.75.75 0 0 1 .75.75v1.5a.75.75 0 0 0 .75.75h2.25a.75.75 0 0 0 .75-.75v-7.5a.75.75 0 0 0-.75-.75h-2.25a.75.75 0 0 0-.75.75v1.5a.75.75 0 0 1-.75-.75H6.633Z" /></svg>
            </button>
            <button (click)="toggleCommentSection(post.id)" class="flex items-center space-x-2 hover:text-text-primary transition-colors group">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 20.25c4.97 0 9-3.694 9-8.25s-4.03-8.25-9-8.25S3 7.444 3 12c0 2.104.859 4.023 2.273 5.48.432.447.74 1.04.586 1.641a4.483 4.483 0 0 1-.923 1.785A5.969 5.969 0 0 0 6 21c1.282 0 2.47-.402 3.445-1.087.81.22 1.668.337 2.555.337Z" /></svg>
            </button>
            <button (click)="toggleRepost(post)" class="flex items-center space-x-2 hover:text-positive-green transition-colors group" [class.text-positive-green]="post.isReposted">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 11.667 0l3.181-3.183m-4.991-2.691v4.992"></path></svg>
            </button>
          </div>
          <div class="flex items-center space-x-4">
             <button (click)="toggleSave(post)" class="flex items-center space-x-2 hover:text-warning-yellow transition-colors group" [class.text-warning-yellow]="post.isSaved">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" [class.fill-current]="post.isSaved" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M17.593 3.322c1.1.128 1.907 1.077 1.907 2.185V21L12 17.5 4.5 21V5.507c0-1.108.806-2.057 1.907-2.185a48.507 48.507 0 0 1 11.186 0Z" />
              </svg>
             </button>
             <button class="flex items-center space-x-2 hover:text-text-primary transition-colors group">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 12 3.269 3.126A59.768 59.768 0 0 1 21.485 12 59.77 59.77 0 0 1 3.27 20.876L5.999 12Zm0 0h7.5" /></svg>
            </button>
          </div>
      </div>
      <!-- Comment Section -->
      @if (activeCommentSection().has(post.id)) {
        <div class="border-t border-border-color px-5 py-4 animate-fade-in">
          <!-- New Comment Form -->
          <div class="flex items-start space-x-3 mb-4">
            <img class="h-8 w-8 rounded-full" src="https://picsum.photos/seed/currentuser/40/40" alt="Your Avatar">
            <div class="flex-1">
              <form (ngSubmit)="postComment(post.id)">
                <textarea [formControl]="commentInput" 
                          (input)="autosizeTextarea($event)"
                          rows="1" 
                          placeholder="Add a comment..." 
                          class="w-full bg-elevated-card border border-border-color rounded-lg px-3 py-2 text-sm placeholder-text-secondary focus:outline-none focus:ring-1 focus:ring-accent-red resize-none"></textarea>
                <div class="text-right mt-2">
                  <button type="submit" [disabled]="commentInput.invalid" class="bg-accent-red text-white px-4 py-1.5 rounded-full text-xs font-bold hover:bg-red-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                    Comment
                  </button>
                </div>
              </form>
            </div>
          </div>
          <!-- Existing Comments -->
          <div class="space-y-4 max-h-60 overflow-y-auto pr-2">
            @for(comment of post.commentData; track comment.id) {
              <div class="flex items-start space-x-3">
                <img class="h-8 w-8 rounded-full" [src]="comment.author.avatar" [alt]="comment.author.name">
                <div class="flex-1 bg-elevated-card rounded-lg p-3">
                  <div class="flex items-baseline space-x-2">
                    <p class="font-semibold text-text-primary text-sm">{{ comment.author.name }}</p>
                    <p class="text-xs text-text-secondary">{{ comment.timestamp }}</p>
                  </div>
                  <p class="text-sm text-text-secondary mt-1 whitespace-pre-wrap">{{ comment.content }}</p>
                </div>
              </div>
            }
          </div>
        </div>
      }
    </div>
  }
</div>
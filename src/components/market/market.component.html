<div class="w-full h-full flex flex-col space-y-4">
  <!-- Market Status Bar -->
  <div class="flex-shrink-0 bg-card-background border border-border-color rounded-lg p-3 flex justify-between items-center">
    <div class="flex items-center space-x-4">
      <span class="text-sm font-semibold text-text-primary">NASDAQ: <span class="text-positive-green">OPEN</span></span>
      <span class="hidden sm:block text-xs text-text-secondary">Closes in 6h 15m</span>
    </div>
    <div class="hidden md:flex items-center space-x-4 text-xs font-mono text-text-primary">
      <span>S&P 500 <span class="text-positive-green">+0.45%</span></span>
      <span>DJIA <span class="text-negative-red">-0.12%</span></span>
      <span>VIX <span class="text-text-secondary">14.23</span></span>
    </div>
  </div>

  <!-- Main Content -->
  <div class="flex-grow flex flex-col lg:flex-row gap-4">
    <!-- Left Panel: Chart & Data -->
    <div class="flex-grow flex flex-col bg-card-background border border-border-color rounded-lg">
      <!-- Asset Tabs -->
      <div class="flex-shrink-0 border-b border-border-color flex">
        @for(tab of tabs; track tab) {
          <button (click)="setActiveTab(tab)" 
                  class="px-4 py-2 text-sm font-medium transition-colors duration-200"
                  [class]="activeTab() === tab ? 'text-text-primary bg-elevated-card' : 'text-text-secondary hover:text-text-primary'">
            {{ tab }}
          </button>
        }
      </div>

      <!-- Content Area -->
      <div class="flex-grow p-4">
        @if(selectedAsset(); as asset) {
          <div class="flex flex-col h-full">
            <!-- Header -->
            <div class="mb-4">
              <h2 class="text-xl font-bold text-text-primary">{{ asset.name }} ({{ asset.symbol }})</h2>
              <div class="flex items-baseline space-x-2">
                <p class="text-3xl font-mono text-text-primary">{{ asset.price | number:'1.2-4' }}</p>
                <p class="text-lg font-mono" [class]="asset.changePercent >= 0 ? 'text-positive-green' : 'text-negative-red'">
                  {{ asset.changeValue >= 0 ? '+' : '' }}{{ asset.changeValue | number:'1.2-4' }} ({{ asset.changePercent >= 0 ? '+' : '' }}{{ asset.changePercent | number:'1.2-2' }}%)
                </p>
              </div>
            </div>

            <!-- Chart Placeholder -->
            <div class="w-full h-64 sm:h-80 bg-background-primary p-2 rounded mb-4">
              <svg width="100%" height="100%" viewBox="0 0 500 250" preserveAspectRatio="none">
                 <path [attr.d]="asset.sparkline" fill="none" [attr.stroke]="asset.changePercent >= 0 ? 'var(--color-positive-green)' : 'var(--color-negative-red)'" stroke-width="2" transform="scale(5, 4)"/>
                <line x1="0" y1="50" x2="500" y2="50" stroke="var(--color-border-color)" stroke-width="0.5" stroke-dasharray="2" />
                <line x1="0" y1="100" x2="500" y2="100" stroke="var(--color-border-color)" stroke-width="0.5" stroke-dasharray="2" />
                <line x1="0" y1="150" x2="500" y2="150" stroke="var(--color-border-color)" stroke-width="0.5" stroke-dasharray="2" />
                 <line x1="0" y1="200" x2="500" y2="200" stroke="var(--color-border-color)" stroke-width="0.5" stroke-dasharray="2" />
              </svg>
            </div>

            <!-- Key Stats -->
            <div class="grid grid-cols-2 sm:grid-cols-3 gap-4 mb-4 text-sm text-text-primary">
              <div class="bg-elevated-card p-2 rounded"> <span class="text-text-secondary">Open:</span> <span class="font-mono float-right">{{ asset.open | number:'1.2-4' }}</span></div>
              <div class="bg-elevated-card p-2 rounded"> <span class="text-text-secondary">High:</span> <span class="font-mono float-right">{{ asset.high | number:'1.2-4' }}</span></div>
              <div class="bg-elevated-card p-2 rounded"> <span class="text-text-secondary">Low:</span> <span class="font-mono float-right">{{ asset.low | number:'1.2-4' }}</span></div>
              @if(asset.marketCap) {
                <div class="bg-elevated-card p-2 rounded"> <span class="text-text-secondary">Mkt Cap:</span> <span class="font-mono float-right">{{ asset.marketCap | number:'1.0-0' }}</span></div>
              }
              @if(asset.volume) {
                <div class="bg-elevated-card p-2 rounded"> <span class="text-text-secondary">Volume:</span> <span class="font-mono float-right">{{ asset.volume | number }}</span></div>
              }
               @if (asset.peRatio) {
                <div class="bg-elevated-card p-2 rounded"> <span class="text-text-secondary">P/E Ratio:</span> <span class="font-mono float-right">{{ asset.peRatio | number:'1.1-1' }}</span></div>
              }
            </div>
            
            <div class="mt-auto space-y-4">
              <!-- Technical Analysis -->
               @if(technicalAnalysis(); as analysis) {
                <div class="bg-elevated-card border border-border-color rounded-lg p-4">
                  <h4 class="text-sm font-semibold text-text-primary mb-2">Technical Analysis</h4>
                  <div class="grid grid-cols-3 gap-2 text-center text-xs mb-2">
                    <div>
                      <p class="font-bold text-lg" [class]="analysis.sentiment === 'Bullish' ? 'text-positive-green' : analysis.sentiment === 'Bearish' ? 'text-negative-red' : 'text-warning-yellow'">
                        {{ analysis.sentiment }}
                      </p>
                      <p class="text-text-secondary">Sentiment</p>
                    </div>
                    <div>
                      <p class="font-mono text-lg text-text-primary">{{ analysis.rsi | number:'1.1-1' }}</p>
                      <p class="text-text-secondary">RSI</p>
                    </div>
                    <div>
                      <p class="font-mono text-lg text-text-primary">{{ analysis.sma20 | number:'1.2-2' }}</p>
                      <p class="text-text-secondary">SMA 20</p>
                    </div>
                  </div>
                   <p class="text-xs text-text-secondary text-center italic">"{{ analysis.summary }}"</p>
                </div>
              }
  
              <!-- AI-Powered Analysis Section -->
              @switch (asset.assetType) {
                @case ('Stock') {
                  <div class="bg-elevated-card border border-border-color rounded-lg p-4">
                    <h4 class="text-sm font-semibold text-text-primary mb-2">AI-Generated Investment Thesis</h4>
                    @if (asset.aiThesis === undefined) {
                      <button (click)="getAIThesis(asset)" class="w-full bg-accent-red text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-red-700 transition-colors flex items-center justify-center space-x-2">
                         <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>
                         <span>Generate AI Thesis</span>
                      </button>
                    } @else if (asset.aiThesis === null) {
                       <div class="text-center text-sm text-text-secondary p-4">Generating...</div>
                    } @else if (asset.aiThesis.error) {
                        <div class="text-center text-sm text-negative-red p-4">{{ asset.aiThesis.error }}</div>
                    } @else {
                      <div class="space-y-3 text-xs animate-fade-in">
                        <div>
                          <p class="font-bold text-positive-green mb-1">Bull Case</p>
                          <p class="text-text-secondary">{{ asset.aiThesis.bull }}</p>
                        </div>
                        <div>
                          <p class="font-bold text-negative-red mb-1">Bear Case</p>
                          <p class="text-text-secondary">{{ asset.aiThesis.bear }}</p>
                        </div>
                      </div>
                    }
                  </div>
                }
                @case ('Crypto') {
                  <div class="bg-elevated-card border border-border-color rounded-lg p-4">
                    <h4 class="text-sm font-semibold text-text-primary mb-2">AI-Generated Smart Contract Audit</h4>
                    @if (asset.aiAudit === undefined) {
                      <button (click)="getAIAudit(asset)" class="w-full bg-accent-red text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-red-700 transition-colors flex items-center justify-center space-x-2">
                         <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12.75 11.25 15 15 9.75m-3-7.036A11.959 11.959 0 0 1 3.598 6 11.99 11.99 0 0 0 3 9.749c0 5.592 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.598-3.751h-.152c-3.196 0-6.1-1.248-8.25-3.286Z"></path></svg>
                         <span>Generate Basic Audit</span>
                      </button>
                    } @else if (asset.aiAudit === null) {
                       <div class="text-center text-sm text-text-secondary p-4">Auditing...</div>
                    } @else if (asset.aiAudit.error) {
                        <div class="text-center text-sm text-negative-red p-4">{{ asset.aiAudit.error }}</div>
                    } @else {
                      <div class="space-y-3 text-xs animate-fade-in">
                        <div>
                          <p class="font-bold text-text-primary mb-1">Summary</p>
                          <p class="text-text-secondary">{{ asset.aiAudit.summary }}</p>
                        </div>
                        <div class="space-y-2 pt-2">
                          @for (item of asset.aiAudit.vulnerabilities; track item.name) {
                            <div class="flex justify-between items-center">
                              <span class="text-text-secondary">{{ item.name }}</span>
                              <span class="px-2 py-0.5 rounded-full text-xs font-semibold"
                                    [class]="{
                                      'bg-negative-red/20 text-negative-red': item.severity === 'High',
                                      'bg-warning-yellow/20 text-warning-yellow': item.severity === 'Medium',
                                      'bg-positive-green/20 text-positive-green': item.severity === 'Low'
                                    }">
                                {{ item.severity }}
                              </span>
                            </div>
                          }
                        </div>
                      </div>
                    }
                  </div>
                }
                @case ('Forex') {
                  <div class="bg-elevated-card border border-border-color rounded-lg p-4">
                    <h4 class="text-sm font-semibold text-text-primary mb-2">AI-Generated Geopolitical Analysis</h4>
                     @if (asset.aiGeopoliticalAnalysis === undefined) {
                      <button (click)="getAIGeopoliticalAnalysis(asset)" class="w-full bg-accent-red text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-red-700 transition-colors flex items-center justify-center space-x-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.75 21v-4.5a3.75 3.75 0 0 1 3.75-3.75h3.75m-7.5 0v-4.5a3.75 3.75 0 0 1 3.75-3.75h3.75m7.5 0v4.5a3.75 3.75 0 0 1-3.75 3.75h-3.75m7.5 0v4.5a3.75 3.75 0 0 1-3.75 3.75h-3.75M3.75 9h7.5m7.5 0h-7.5" /></svg>
                         <span>Generate Analysis</span>
                      </button>
                    } @else if (asset.aiGeopoliticalAnalysis === null) {
                       <div class="text-center text-sm text-text-secondary p-4">Analyzing...</div>
                    } @else if (asset.aiGeopoliticalAnalysis.error) {
                        <div class="text-center text-sm text-negative-red p-4">{{ asset.aiGeopoliticalAnalysis.error }}</div>
                    } @else {
                      <div class="space-y-3 text-xs animate-fade-in">
                        <div>
                          <p class="font-bold text-text-primary mb-1">Summary</p>
                          <p class="text-text-secondary">{{ asset.aiGeopoliticalAnalysis.summary }}</p>
                        </div>
                        <div class="space-y-2 pt-2">
                          @for (item of asset.aiGeopoliticalAnalysis.factors; track item.name) {
                            <div class="flex justify-between items-center">
                              <span class="text-text-secondary">{{ item.name }}</span>
                              <span class="px-2 py-0.5 rounded-full text-xs font-semibold"
                                    [class]="{
                                      'bg-negative-red/20 text-negative-red': item.impact === 'Negative',
                                      'bg-warning-yellow/20 text-warning-yellow': item.impact === 'Neutral',
                                      'bg-positive-green/20 text-positive-green': item.impact === 'Positive'
                                    }">
                                {{ item.impact }}
                              </span>
                            </div>
                          }
                        </div>
                      </div>
                    }
                  </div>
                }
                @case ('Commodity') {
                  <div class="bg-elevated-card border border-border-color rounded-lg p-4">
                    <h4 class="text-sm font-semibold text-text-primary mb-2">AI-Generated Supply Chain Outlook</h4>
                     @if (asset.aiSupplyChainOutlook === undefined) {
                      <button (click)="getAISupplyChainOutlook(asset)" class="w-full bg-accent-red text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-red-700 transition-colors flex items-center justify-center space-x-2">
                         <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.25 18.75a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m3 0h6m-9 0H3.375a1.125 1.125 0 0 1-1.125-1.125V14.25m17.25 4.5a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m3 0h1.125c.621 0 1.125-.504 1.125-1.125V14.25m-17.25 4.5v-1.875a3.375 3.375 0 0 1 3.375-3.375h9.75a3.375 3.375 0 0 1 3.375 3.375v1.875M10.5 6h3m-3 0h-3m3 0-3 3m6 0h3m-3 0h-3m-3 0 3 3m0 0-3 3m3-3 3 3" /></svg>
                         <span>Generate Outlook</span>
                      </button>
                    } @else if (asset.aiSupplyChainOutlook === null) {
                       <div class="text-center text-sm text-text-secondary p-4">Generating...</div>
                    } @else if (asset.aiSupplyChainOutlook.error) {
                        <div class="text-center text-sm text-negative-red p-4">{{ asset.aiSupplyChainOutlook.error }}</div>
                    } @else {
                      <div class="space-y-3 text-xs animate-fade-in">
                        <div>
                          <p class="font-bold text-text-primary mb-1">Summary</p>
                          <p class="text-text-secondary">{{ asset.aiSupplyChainOutlook.summary }}</p>
                        </div>
                        <div class="space-y-2 pt-2">
                          @for (item of asset.aiSupplyChainOutlook.outlook_points; track item.point) {
                            <div class="flex justify-between items-center">
                              <span class="text-text-secondary w-4/5">{{ item.point }}</span>
                              <span class="px-2 py-0.5 rounded-full text-xs font-semibold"
                                    [class]="{
                                      'bg-negative-red/20 text-negative-red': item.type === 'Risk',
                                      'bg-positive-green/20 text-positive-green': item.type === 'Opportunity'
                                    }">
                                {{ item.type }}
                              </span>
                            </div>
                          }
                        </div>
                      </div>
                    }
                  </div>
                }
              }
            </div>

          </div>
        } @else {
          <div class="text-center p-10 text-text-secondary">Select an asset from the watchlist to view details.</div>
        }
      </div>
    </div>

    <!-- Right Panel: Watchlist -->
    <div class="w-full lg:w-72 flex-shrink-0 bg-card-background border border-border-color rounded-lg">
      <div class="p-4 border-b border-border-color">
        <h3 class="text-sm font-semibold text-text-primary">Watchlist</h3>
      </div>
      <div class="p-2 space-y-1 max-h-[calc(100vh-14rem)] overflow-y-auto">
        @for(item of watchlist(); track item.symbol) {
          <div (click)="selectAsset(item)"
               class="p-2 rounded-md cursor-pointer grid grid-cols-3 gap-2 items-center transition-colors"
               [class]="selectedAsset()?.symbol === item.symbol ? 'bg-elevated-card' : 'hover:bg-elevated-card'">
            <!-- Symbol & Name -->
            <div class="col-span-1">
              <p class="text-sm font-bold text-text-primary">{{ item.symbol }}</p>
              <p class="text-xs text-text-secondary truncate">{{ item.name }}</p>
            </div>
            <!-- Sparkline -->
            <div class="col-span-1 flex justify-center items-center">
              <svg width="100" height="40" viewBox="0 0 100 60">
                 <path [attr.d]="item.sparkline" fill="none" [attr.stroke]="item.changePercent >= 0 ? 'var(--color-positive-green)' : 'var(--color-negative-red)'" stroke-width="2"/>
              </svg>
            </div>
            <!-- Price & Change -->
            <div class="col-span-1 text-right">
              <p class="text-sm font-mono text-text-primary">{{ item.price | number:'1.2-4' }}</p>
              <p class="text-xs font-mono" [class]="item.changePercent >= 0 ? 'text-positive-green' : 'text-negative-red'">
                {{ item.changePercent >= 0 ? '+' : '' }}{{ item.changePercent | number:'1.2-2' }}%
              </p>
            </div>
          </div>
        }
      </div>
    </div>
  </div>
</div>